# 程式說明文件

## 檔案結構與路徑

### HTML 主檔案
- **路徑**: `index.html`
- **作用**: 主頁面，定義所有 UI 元素和載入所有 JavaScript 模組

### JavaScript 模組（位於 `js/` 資料夾）

#### 1. `js/data.js`
- **路徑**: `js/data.js`
- **功能**: 
  - 地標資料管理系統（MarkerDataManager 類別）
  - 處理地標的增刪改查
  - 使用 LocalStorage 儲存地標資料
  - 提供匯入/匯出 JSON 功能
  - 圖片處理工具（ImageUtils 類別）
- **頁面物件**: 無直接對應的 HTML 元素，提供後端資料管理功能
- **全域變數**: `markerDataManager` - 地標資料管理器實例

#### 2. `js/model-loader.js`
- **路徑**: `js/model-loader.js`
- **功能**:
  - 模型載入器（ModelLoader 類別）
  - 支援多種 3D 模型格式：STL、OBJ、GLTF/GLB
  - 自動載入對應的 MTL 材質檔
  - 處理模型旋轉、縮放、位置調整
  - 動態載入 Three.js Loader（OBJLoader、MTLLoader、STLLoader、GLTFLoader）
- **頁面物件**: 無直接對應的 HTML 元素，負責載入 3D 模型
- **載入的模型路徑**:
  - `models/building.obj` + `models/building.mtl` - 建築物模型
  - `models/ground.obj` + `models/ground.mtl` - 地面模型

#### 3. `js/map3d.js`
- **路徑**: `js/map3d.js`
- **功能**:
  - 3D 地圖核心功能（Map3D 類別）
  - 初始化 Three.js 場景、相機、渲染器
  - 載入並顯示 3D 模型
  - 管理地標標記（添加、刪除、更新）
  - 處理滑鼠互動（旋轉、平移、縮放）
  - 點擊檢測與地標選擇
  - 資訊面板顯示/隱藏
  - 線框模式切換
  - 編輯模式（可拖動地標）
  - 街景模式支援
  - 相機動畫（flyTo 效果）
- **頁面物件**:
  - `#canvas-container` - 3D 地圖容器
  - `#infoPanel` - 資訊面板
  - `#infoTitle` - 地標名稱
  - `#infoImage` - 地標照片
  - `#infoDescription` - 地標簡介
  - `#closeInfoBtn` - 關閉資訊面板按鈕
  - `#editInfoBtn` - 編輯地標按鈕
  - `#deleteInfoBtn` - 刪除地標按鈕
- **全域變數**: `map3D` - 3D 地圖實例

#### 4. `js/marker-editor.js`
- **路徑**: `js/marker-editor.js`
- **功能**:
  - 標記編輯器（MarkerEditor 類別）
  - 處理地標的添加、編輯、刪除
  - 管理編輯器模態框
  - 處理圖片上傳與預覽
  - 地標列表更新
  - 匯入/匯出地標資料
  - 編輯模式切換
  - 位置選擇功能
- **頁面物件**:
  - `#addMarkerBtn` - 添加地標按鈕
  - `#editModeBtn` - 編輯模式按鈕
  - `#resetViewBtn` - 重置視角按鈕
  - `#toggleWireframeBtn` - 線框模式按鈕
  - `#exportMarkersBtn` - 匯出地標按鈕
  - `#importMarkersBtn` - 匯入地標按鈕
  - `#importFileInput` - 匯入檔案輸入（隱藏）
  - `#markerEditorModal` - 標記編輯器模態框
  - `#modalTitle` - 模態框標題
  - `#closeModalBtn` - 關閉模態框按鈕
  - `#markerName` - 地標名稱輸入
  - `#markerDescription` - 地標簡介輸入
  - `#markerImage` - 地標照片上傳
  - `#imagePreview` - 圖片預覽區域
  - `#markerX`, `#markerY`, `#markerZ` - 座標輸入
  - `#selectPositionBtn` - 在地圖上選擇位置按鈕
  - `#saveMarkerBtn` - 儲存地標按鈕
  - `#cancelMarkerBtn` - 取消按鈕
  - `#markerListPanel` - 地標列表側邊欄
  - `#markerListItems` - 地標列表項目容器

#### 5. `js/street-view.js`
- **路徑**: `js/street-view.js`
- **功能**:
  - 街景/平面漫遊控制器（StreetViewController 類別）
  - 第一人稱視角漫遊
  - 鍵盤控制移動（WASD、方向鍵）
  - 碰撞偵測（避免穿牆）
  - 相機高度固定
  - 左右轉向控制
- **頁面物件**:
  - `#streetViewBtn` - 街景模式切換按鈕
- **全域變數**: `streetViewController` - 街景控制器實例
- **控制方式**:
  - `W` / `↑` - 前進
  - `S` / `↓` - 後退
  - `A` - 左移
  - `D` - 右移
  - `←` - 左轉
  - `→` - 右轉
  - `Esc` - 離開街景模式


#### 7. `js/map-search.js`
- **路徑**: `js/map-search.js`
- **功能**:
  - 地標搜尋功能（MapSearch 類別）
  - 模仿 Google Maps 的搜尋框
  - 即時搜尋地標（名稱或簡介）
  - 鍵盤導航（上下箭頭、Enter、Esc）
  - 搜尋結果顯示
  - 點擊結果跳轉到地標
- **頁面物件**:
  - `#searchInput` - 搜尋輸入框
  - `#searchResults` - 搜尋結果容器

### CSS 樣式檔案
- **路徑**: `css/styles.css`
- **功能**: 定義所有頁面元素的樣式

### 3D 模型檔案（位於 `models/` 資料夾）
- `models/building.obj` + `models/building.mtl` - 建築物模型與材質
- `models/ground.obj` + `models/ground.mtl` - 地面模型與材質

### 圖片檔案（位於 `images/` 資料夾）
- 所有地標相關的 `.jpg` 和 `.jpeg` 圖片檔案

---

## 頁面物件完整清單

### Header 區域
- `h1` - 標題「師大附中 3D 校園地圖」
- `#searchInput` - 搜尋輸入框
- `#searchResults` - 搜尋結果下拉選單
- `#addMarkerBtn` - 添加地標按鈕
- `#streetViewBtn` - 街景模式按鈕
- `#resetViewBtn` - 重置視角按鈕
- `#exportMarkersBtn` - 匯出地標按鈕
- `#importMarkersBtn` - 匯入地標按鈕
- `#importFileInput` - 匯入檔案輸入（隱藏）

### 3D 地圖區域
- `#canvas-container` - 3D 地圖容器（Three.js 渲染器會插入 canvas）

### 資訊面板
- `#infoPanel` - 資訊面板容器
- `#closeInfoBtn` - 關閉按鈕（×）
- `#infoContent` - 資訊內容容器
- `#infoTitle` - 地標名稱標題
- `#infoImageContainer` - 圖片容器
- `#infoImage` - 地標照片
- `#infoDescription` - 地標簡介
- `#editInfoBtn` - 編輯按鈕
- `#deleteInfoBtn` - 刪除按鈕

### 地標列表側邊欄
- `#markerListPanel` - 地標列表面板
- `h3` - 「地標列表」標題
- `#markerListItems` - 地標列表項目容器

### 標記編輯器模態框
- `#markerEditorModal` - 模態框容器
- `#modalTitle` - 模態框標題（「添加地標」或「編輯地標」）
- `#closeModalBtn` - 關閉按鈕（×）
- `#markerName` - 地標名稱輸入框
- `#markerDescription` - 地標簡介文字區域
- `#markerImage` - 照片上傳輸入
- `#imagePreview` - 圖片預覽區域
- `#markerX` - X 座標輸入
- `#markerY` - Y 座標輸入
- `#markerZ` - Z 座標輸入
- `#selectPositionBtn` - 在地圖上選擇位置按鈕
- `#saveMarkerBtn` - 儲存按鈕
- `#cancelMarkerBtn` - 取消按鈕

---

## 程式載入順序

1. `index.html` 載入
2. Three.js 庫載入（CDN）
3. Three.js Loaders 載入（MTLLoader、OBJLoader、STLLoader）
4. `js/data.js` - 初始化資料管理器
5. `js/model-loader.js` - 定義模型載入器
6. `js/map3d.js` - 初始化 3D 地圖（會載入模型）
7. `js/marker-editor.js` - 初始化標記編輯器
8. `js/street-view.js` - 初始化街景控制器
9. `js/map-search.js` - 初始化搜尋功能

---

## 主要功能流程

### 添加地標流程
1. 點擊 `#addMarkerBtn` → 開啟編輯器模態框
2. 填寫名稱、簡介、上傳照片
3. 點擊 `#selectPositionBtn` → 進入位置選擇模式
4. 點擊 3D 地圖上的位置 → 設定座標
5. 點擊 `#saveMarkerBtn` → 儲存到 `markerDataManager` → 添加到 3D 場景 → 更新列表

### 搜尋地標流程
1. 在 `#searchInput` 輸入關鍵字
2. `MapSearch` 即時過濾地標
3. 顯示搜尋結果在 `#searchResults`
4. 點擊結果 → 調用 `map3D.onMarkerClick()` → 顯示資訊面板並移動相機

### 街景模式流程
1. 點擊 `#streetViewBtn` → 啟動 `StreetViewController`
2. 相機移動到地面高度
3. 隱藏建築名稱標籤
4. 啟用鍵盤控制
5. 碰撞偵測防止穿牆
6. 按 `Esc` 或再次點擊按鈕 → 退出街景模式

---

## 資料流向

```
使用者操作
    ↓
HTML 元素事件
    ↓
JavaScript 模組處理
    ↓
markerDataManager (資料管理)
    ↓
map3D (3D 場景更新)
    ↓
LocalStorage (持久化儲存)
```

---

## 全域變數

- `map3D` - Map3D 實例（3D 地圖核心）
- `markerDataManager` - MarkerDataManager 實例（資料管理）
- `streetViewController` - StreetViewController 實例（街景控制）

---

## 外部依賴

- **Three.js r128** - 3D 圖形庫（CDN）
- **MTLLoader** - MTL 材質載入器（CDN）
- **OBJLoader** - OBJ 模型載入器（CDN）
- **STLLoader** - STL 模型載入器（CDN，備用）

